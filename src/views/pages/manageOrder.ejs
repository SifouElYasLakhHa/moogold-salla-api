<!DOCTYPE html>
<html class="loading dark-layout" lang="en" data-layout="dark-layout" data-textdirection="rtl">
<!-- BEGIN: Head-->

<head>
    <%- include('../partials/authHeader.ejs'); %>
</head>
<!-- END: Head-->

<!-- BEGIN: Body-->

<body class="horizontal-layout horizontal-menu  navbar-floating footer-static  " data-open="hover" data-menu="horizontal-menu" data-col="">
    <%- include('../partials/nav.ejs'); %>
    <%- include('../moduls/manageOrder.ejs'); %>
    <%- include('../partials/footer.ejs'); %>
    <%- include('../partials/authFooter.ejs'); %>
    <script>
        var host = '<%- host %>';
        var fields = [];
        var type = 0;
        $('#gameName').change(function() {
            $('#server').empty();
            $('#typeOrder').empty();
            $('#diamonds').empty();
            var gameCode = $('#gameName').val();
            var settings = {
                "url": `${host}/admin/game/views?gameCode=${gameCode}`,
                "method": "GET",
                "timeout": 0,
                "headers": {
                    "Content-Type": "application/json"
                },
                "data": {},
            };

            $.ajax(settings).done(function (response) {
                if(response.status === true) {
                    $('#gameError').text();
                    var htmlServerContent = '<option value="">اختيار طريقة الحشن</option>';
                    var htmlDenominationsContent = '';
                    for(var d of response.gameDetails.denominations) {
                        htmlDenominationsContent += '<option value="';
                        htmlDenominationsContent += d.id;
                        htmlDenominationsContent += '">';
                        htmlDenominationsContent += d.name;
                        htmlDenominationsContent += '</option>';
                        //`<option value="${d.id}">${d.name}</option>`;
                    }
                    
                    $('#diamonds').append(htmlDenominationsContent);
                    
                    for(var f of response.gameDetails.fields) {
                        /*htmlServerContent += '<option value="' 
                        htmlServerContent +=  f.type;
                        htmlServerContent += '">';
                        htmlServerContent += f.name;
                        htmlServerContent += '</option>';*/
                        if(f.type === 'dropdown') {
                            fields = f.data;
                            type = 1;
                        }
                    }
                    if(type === 1) {
                        var htmlServerContent = '<option value="">اختيار السرفر</option>';
                        for(var f of fields) {
                            htmlServerContent += '<option value="';
                            htmlServerContent += f.value;
                            htmlServerContent += '">';
                            htmlServerContent += f.name;
                            htmlServerContent += '</option>';
                        }
                        $('#server').empty();
                        $('#server').append(htmlServerContent);
                        $('.zoneID').hide();
                        $('.server').show();
                        $('#addOrder').attr('type', '2');
                        //2
                    } else {
                        $('.zoneID').show();
                        $('.server').hide();
                        $('#addOrder').attr('type', '1');
                    }
                    //$('#typeOrder').append(htmlServerContent);
                    //fields
                } else {
                    $('#gameError').text(response.error.message);
                }
            });
        });
        /*$('#typeOrder').change(function() {
            var typeOrder = $('#typeOrder').val();
            if(typeOrder === 'dropdown') {
                var htmlServerContent = '<option value="">اختيار السرفر</option>';
                for(var f of fields) {
                    htmlServerContent += '<option value="';
                    htmlServerContent += f.type;
                    htmlServerContent += '">';
                    htmlServerContent += f.name;
                    htmlServerContent += '</option>';
                }
                $('#server').empty();
                $('#server').append(htmlServerContent);
            }
        });*/
        $('#addOrder').click(function() {
            var type =  $('#addOrder').attr('type'); 
            var strRequest = '';
            var userID = $('#userId').val();
            var gameName = $('#gameName').val();
            if(type === 1) {
                var server = $('#server').val();
                strRequest = `?gameCode=${gameName}&server=${server}&userId=${userID}`;
            } else {
                var zoneId = $('#zoneId').val();
                strRequest = `?gameCode=${gameName}&userId=${userId}&zoneId=${zoneId}`;
            }
            var settings = {
                "url": `${host}/admin/user/validate${strRequest}`,
                "method": "POST",
                "timeout": 0,
            };

            $.ajax(settings).done(function (response) {
                if(response.status === false) {
                    $('#error_full').text(response.errors.message);
                } else {
                    $('#error_full').text();
                    var settings = {
                        "url": `${host}/admin/order/add?gameCode=${gameName}&validationToke=${response.validationToken}&denominationId=${$('#diamonds').val()}`,
                        "method": "POST",
                        "timeout": 0,
                        "headers": {
                            "Content-Type": "application/json"
                        },
                        "data": {
                            "userId": userID,
                            "gameCode": gameName,
                            "type": type,
                            "denominationId": $('#diamonds').val()
                        },
                    };

                    $.ajax(settings).done(function (response) {
                        if(response.status === false) {
                            $('#error_full').text(response.errors.message);
                        } else {
                            $('#error_full').text('Success');
                            $('#userId').val('');
                            $('#zoneId').val('');
                            window.location.reload();
                        }
                    })
                }
                //console.log(response);
            });
        })
    </script>
</body>
<!-- END: Body-->

</html>